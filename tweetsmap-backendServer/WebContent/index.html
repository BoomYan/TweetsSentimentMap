<!DOCTYPE html>

<html>
<head>
<title>Tweets Map by Jiaming Yan</title>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<style>
html, body {
	height: 100%;
	margin: 0;
	padding: 0;
}

#map {
	height: 100%;
}
</style>
</head>
<body>

	<div>
		<select id="messageinput">
			<option value="" disabled="disabled" selected="selected">Please
				select a candidate to track</option>
			<option value="trump">Donald Trump</option>
			<option value="cruz">Ted Cruz</option>
			<option value="clinton">Hillary Clinton</option>
			<option value="sanders">Bernie Sanders</option>
		</select>
	</div>
	<div>
		<button type="button" onclick="openSocket();">Open
			Connection</button>
		<button type="button" onclick="search();" value="@">Start
			Tracking!</button>
		<button type="button" onclick="searchNearAMarker();" value="@">Search
			Near A Marker!</button>
		<button type="button" onclick="closeSocket();">Stop
			Tracking!</button>
	</div>
	<!-- Server responses get written here -->
	<div id="messages"></div>
	<div id="map"></div>

	<!-- Script to utilise the WebSocket -->
	<script src="http://maps.googleapis.com/maps/api/js?sensor=false"></script>
	<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnYagsLl9_liiKrxaSqWA3wvAssLIy0nw&libraries=visualization&callback=initMap"></script>

	<script type="text/javascript">
            //handling websocket operations           
            var webSocket;
            var messages = document.getElementById("messages");
                      
            function openSocket(){
                if(webSocket !== undefined && webSocket.readyState !== WebSocket.CLOSED){
                   writeResponse("WebSocket is already opened.");
                    return;
                }
                // Create a new instance of the websocket
                if (location.host === "localhost:8080") {
                	webSocket = new WebSocket("ws://"+ location.host + "/tweetsmap-backendServer/server");
                }
                else {
                	webSocket = new WebSocket("ws://"+ location.host + ":8080/server");
                }

                webSocket.onopen = function(event){
                    if(event.data === undefined)
                        return;
                    writeResponse(event.data);
                };
 
                webSocket.onmessage = function(event){
                    writeResponse(event.data);
                    var response = JSON.parse(event.data);
                    switch (response.command) {
	                    case "searchResponse": 
	                    	var loc = response.tweet.location;
	                    	var latlng = String(loc).split(",");
	                    	addPoint(new google.maps.LatLng(latlng[0], latlng[1]));
	                    	break;
	                    case "newlyIndexedTweet":
	                    	writeResponse("A new tweet is indexed: " + response.tweet.text);
	                    	break;
	                    default:
	                    	writeResponse(response.command);
                    }
                };
 
                webSocket.onclose = function(event){
                    writeResponse("Connection closed");
                };
            }
            openSocket();
            /**
             * Sends the value of the text input to the server
             */
            function sendMessage(msg) {
                webSocket.send(msg);
                removeAllPoints();
            }
            function search() {
            	var msg = {};
            	msg.command = "getTweets";
            	msg.query = getText();
            	sendMessage(JSON.stringify(msg));            	
            }
            function searchNearAMarker() {
            	var msg = {};
            	msg.command = "getTweets";
            	msg.query = getText();
            	msg.location = marker.getPosition().lat() + "," +  marker.getPosition().lng();
            	sendMessage(JSON.stringify(msg));
            }
           
            function closeSocket(){
                webSocket.close();
            }
 			function getText() {
 				var text = document.getElementById("messageinput").value;
 				return text;
 			}
            function writeResponse(text){
                messages.innerHTML = "<br/>" + text;
                messages.innerHTML += "<br/>" + "Count:" + points.length;
            }
           
        	//handling map operations
        	var points = new google.maps.MVCArray([]);
        	var map;
        	var heatmap;
        	var marker;
            function initMap() {
            	var sanFrancisco = new google.maps.LatLng(37.774546, -122.433523);
            	
                map = new google.maps.Map(document.getElementById('map'), {
                	center: sanFrancisco,
                	zoom: 3,
                });
                
                marker = new google.maps.Marker({
                    position: sanFrancisco,
                    map: map
                });
                
                google.maps.event.addListener(map, 'click', function(event){
                	  marker.setPosition(event.latLng);
                });
                
                //points.push(sanFrancisco); 
                
                heatmap = new google.maps.visualization.HeatmapLayer({
                	  data: points,
                	  radius: 50
                });
                
                heatmap.setMap(map);
                
/* 				addPoint(new google.maps.LatLng(37.782, -122.447)); */
            }
            function addPoint(latlon) {
            	points.push(latlon);
            }
            function removePoint() {
            	points.shift();
            }
            function removeAllPoints() {
            	points.clear();
            }
        </script>
	<script>
        </script>

</body>
</html>